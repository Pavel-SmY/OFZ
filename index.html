<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ОФЗ — данные Московской биржи</title>

  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <div class="container">
    <h1>Облигации федерального займа (ОФЗ)</h1>

    <p class="intro">
      На этой странице отображаются реальные данные по ОФЗ,
      полученные напрямую с Московской биржи.
      Инструменты предназначены для обучения и первичного анализа.
    </p>

    <!-- ================= СПИСОК ОФЗ ================= -->

    <section>
      <h2>Список ОФЗ (MOEX)</h2>

      <table id="ofzTable">
        <thead>
          <tr>
            <th>Код</th>
            <th>Название</th>
            <th>Погашение</th>
            <th>Купон</th>
            <th>Выбрать</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="5">Загрузка данных…</td>
          </tr>
        </tbody>
      </table>

      <p class="note">
        Источник: MOEX ISS API. Данные обновляются автоматически.
      </p>
    </section>

    <!-- ================= КАЛЬКУЛЯТОР ================= -->

    <section>
      <h2>Калькулятор доходности выбранной ОФЗ</h2>

      <div class="calculator">
        <label>
          Цена (% от номинала)
          <input type="number" id="price" value="95" step="0.1">
        </label>

        <label>
          Купон (% годовых)
          <input type="number" id="coupon" value="0" step="0.01" readonly>
        </label>

        <label>
          Срок до погашения (лет)
          <input type="number" id="years" value="0" readonly>
        </label>

        <button id="calcBtn">Рассчитать доходность</button>
        <div class="result" id="result"></div>
      </div>

      <p class="note">
        ⚠️ Доходность рассчитывается по упрощённой формуле и не является официальной YTM.
      </p>
    </section>

    <!-- ================= ГРАФИК ================= -->

    <section>
      <h2>Кривая доходности ОФЗ (оценка)</h2>
      <canvas id="yieldCurveChart"></canvas>
      <p class="note">
        График построен на основе оценочной доходности по выбранным ОФЗ.
      </p>
    </section>

    <footer>
      <p class="disclaimer">
        Материал носит информационный характер и не является инвестиционной рекомендацией.
      </p>
    </footer>
  </div>

  <!-- ================= JS ================= -->

  <script>
    const ofzTableBody = document.querySelector('#ofzTable tbody');
    const couponInput = document.getElementById('coupon');
    const yearsInput = document.getElementById('years');
    const priceInput = document.getElementById('price');
    const resultDiv = document.getElementById('result');

    let yieldChart;
    const curveData = [];

    // ===== ЗАГРУЗКА ОФЗ =====
    async function loadOFZ() {
      const url =
        'https://iss.moex.com/iss/engines/stock/markets/bonds/boards/TQOB/securities.json';

      const res = await fetch(url);
      const data = await res.json();

      const cols = data.securities.columns;
      const rows = data.securities.data;

      const iSec = cols.indexOf('SECID');
      const iName = cols.indexOf('SHORTNAME');
      const iMat = cols.indexOf('MATDATE');
      const iCoupon = cols.indexOf('COUPONPERCENT');

      ofzTableBody.innerHTML = '';

      rows.slice(0, 20).forEach(r => {
        const maturity = r[iMat];
        const years =
          maturity
            ? Math.max(
                1,
                Math.round(
                  (new Date(maturity) - new Date()) /
                  (365 * 24 * 60 * 60 * 1000)
                )
              )
            : null;

        ofzTableBody.innerHTML += `
          <tr>
            <td>${r[iSec]}</td>
            <td>${r[iName]}</td>
            <td>${maturity || '—'}</td>
            <td>${r[iCoupon] ?? '—'}</td>
            <td>
              <button onclick="selectOFZ(${r[iCoupon] || 0}, ${years || 1})">
                Выбрать
              </button>
            </td>
          </tr>`;
      });
    }

    // ===== ВЫБОР ОФЗ =====
    function selectOFZ(coupon, years) {
      couponInput.value = coupon;
      yearsInput.value = years;
      resultDiv.innerText = 'ОФЗ выбрана. Нажмите «Рассчитать доходность».';
    }

    // ===== КАЛЬКУЛЯТОР =====
    document.getElementById('calcBtn').addEventListener('click', () => {
      const price = +priceInput.value;
      const coupon = +couponInput.value;
      const years = +yearsInput.value;

      const nominal = 100;
      const annualCoupon = coupon / 100 * nominal;

      const y =
        (annualCoupon + (nominal - price) / years) /
        ((nominal + price) / 2) * 100;

      resultDiv.innerText = `Оценочная доходность: ${y.toFixed(2)}% годовых`;

      curveData.push({ years, y });
      updateCurve();
    });

    // ===== ГРАФИК =====
    function updateCurve() {
      const labels = curveData.map(p => `${p.years} лет`);
      const values = curveData.map(p => p.y);

      if (yieldChart) yieldChart.destroy();

      yieldChart = new Chart(
        document.getElementById('yieldCurveChart'),
        {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Доходность, %',
              data: values,
              borderColor: '#2563eb',
              fill: false
            }]
          }
        }
      );
    }

    loadOFZ();
  </script>
</body>
</html>